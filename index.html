<html>
  <link rel="manifest" href="manifest.json" />
  <link rel="stylesheet" href="styles.css" />

  <head>
    <title>Wake on Lan!</title>
    <meta
      http-equiv="Content-Security-Policy"
      content="connect-src http: https:"
    />
    <link
      rel="icon"
      type="image/png"
      sizes="32x32"
      href="icons/favicon-32x32.png"
    />
  </head>

  <body>
    <h1>Wake on Lan!</h1>
    <button id="power-button" onclick="handleButton('power')">Power</button>
    <button id="power-hold-button" onclick="handleButton('powerHold')">
      Power Hold
    </button>
    <button id="reset-button" onclick="handleButton('reset')">Reset</button>
    <span id="status-text">Waiting</span>
    <input type="text" id="server-input" placeholder="Server" />
    <input type="text" id="port-input" placeholder="Port" />
    <input type="text" id="hostname-input" placeholder="Hostname" />
    <input type="password" id="password-input" placeholder="Password" />
    <button onclick="saveConfig()">Save</button>
    <button onclick="clearConfig()">Clear</button>
  </body>

  <script>
    // Load saved values
    document.getElementById("server-input").value =
      localStorage.getItem("server") || "";
    document.getElementById("port-input").value =
      localStorage.getItem("port") || "";
    document.getElementById("hostname-input").value =
      localStorage.getItem("host") || "";
    document.getElementById("password-input").value =
      localStorage.getItem("password") || "";

    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("service-worker.js");
    }

    function saveConfig() {
      const server = getServer();
      const port = getPort();
      const host = getHostname();
      const password = getPassword();

      localStorage.setItem("server", server);
      localStorage.setItem("port", port);
      localStorage.setItem("host", host);
      localStorage.setItem("password", password);
      alert("Saved!");
    }

    function clearConfig() {
      localStorage.removeItem("server");
      localStorage.removeItem("port");
      localStorage.removeItem("host");
      localStorage.removeItem("password");

      document.getElementById("server-input").value = "";
      document.getElementById("port-input").value = "";
      document.getElementById("hostname-input").value = "";
      document.getElementById("password-input").value = "";
      alert("Cleared!");
    }

    function getServer() {
      return document.getElementById("server-input").value;
    }

    function getPort() {
      return document.getElementById("port-input").value;
    }

    function getHostname() {
      return document.getElementById("hostname-input").value;
    }

    function getPassword() {
      return document.getElementById("password-input").value;
    }

    function setStatusLoading(action) {
      document.getElementById("status-text").innerText = "Loading " + action;
    }

    async function getStatus(host, action, password) {
      try {
        const server = getServer();
        const port = getPort();

        const response = await fetch(
          `https://${host}/${action}?key=${password}&server=${server}&port=${port}`,
          {
            method: "GET",
          }
        );
        console.log("response", response);
        const status = await response.text();
        document.getElementById("status-text").innerText = status;
      } catch (error) {
        console.log("error", error);
        document.getElementById("status-text").innerText = "error";
        return;
      }
    }

    async function handleButton(button) {
      setStatusLoading(button);
      await getStatus(getHostname(), button, getPassword());
    }
  </script>
</html>
